<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Class Jeopardy Review</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --ink:#1f1f1f;
      --muted:#5b5870;
      --accent:#6a4cff;
      --accent2:#f04bd8;
      --tile:#4e34ab;
      --tile2:#724ede;
      --good:#2ecc71;
      --bad:#ff6b6b;
      --warn:#f5c04c;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }

    header{
      padding: 18px 16px 8px;
      text-align:center;
    }
    header h1{ margin: 4px 0 6px; font-size: 26px; }
    header p{ margin:0; color: var(--muted); font-size: 14px; }

    .wrap{
      max-width: 1180px;
      margin: 14px auto 34px;
      padding: 0 14px;
    }

    .layout{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }

    .cardHeader{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      background: rgba(198, 76, 255, 0.1);
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
      text-transform: uppercase;
      color: #2b2470;
    }

    .cardBody{ padding: 12px 14px; }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:none;
      background: var(--accent);
      color:white;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      font-weight: 650;
    }
    .btn.secondary{ background: #ffffff; color: var(--ink); border: 1px solid rgba(0,0,0,.12); box-shadow:none;}
    .btn.danger{ background: var(--bad); }
    .btn.good{ background: var(--good); }
    .btn.warn{ background: var(--warn); color:#2a1c00; }
    .btn:active{ transform: translateY(1px); }

    .pill{
      background: rgba(106, 76, 255, .12);
      color: #130313;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pill input[type="number"]{
      width: 62px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.18);
      padding: 6px 8px;
      background:white;
    }
    .pill input[type="checkbox"]{
      transform: translateY(1px);
    }

    /* Board */
    .board{
      padding: 12px;
      overflow:visible;
    }
    .grid{
      display:grid;
      gap: 10px;
      min-width: 0;
      width: 100%;
    }
    .cell{
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 10px;
      user-select:none;
      min-width: 0;
    }
    .cat{
      background: linear-gradient(180deg, var(--tile2), var(--tile));
      color: white;
      font-weight: 800;
      letter-spacing: .4px;
      text-transform: uppercase;
      font-size: 12px;
      min-height: 62px;
      word-break: break-word;
    }
    .qbtn{
      background: #eba4ff;
      color: #3d0c6c;
      font-weight: 900;
      font-size: 20px;
      cursor:pointer;
      min-height: 70px;
      border: 2px solid rgba(255,255,255,.10);
      transition: transform .06s ease;
    }
    .qbtn:hover{ transform: translateY(-1px); }
    .qbtn.used{
      background: #d8d8e8;
      color: #7b7b92;
      cursor:not-allowed;
      text-decoration: line-through;
      border-color: rgba(0,0,0,.08);
    }

    /* Setup */
    .setupRow{
      display:grid;
      gap:10px;
    }
    .setupRow label{
      font-size: 13px;
      color: var(--muted);
      font-weight: 650;
      display:block;
      margin-bottom: 6px;
    }
    .setupRow input[type="text"], .setupRow input[type="number"], .setupRow textarea{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.14);
      font-size: 14px;
      background: white;
      box-sizing: border-box;
      font: inherit;
    }
    .teamInputs{
      display:grid;
      gap:8px;
      margin-top: 6px;
    }

    /* Scoreboard */
    .scoreList{
      display:grid;
      gap:10px;
    }
    .teamCard{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: #fafafe;
    }
    .teamName{
      font-weight: 850;
      font-size: 14px;
    }
    .teamScore{
      font-weight: 950;
      font-size: 18px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.06);
      min-width: 72px;
      text-align:right;
    }
    .teamMiniBtns{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini{
      padding: 7px 9px;
      border-radius: 10px;
      font-weight: 800;
      box-shadow:none;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(960px, 100%);
      background: white;
      border-radius: 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.12);
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      background: rgba(106, 76, 255, .10);
      border-bottom: 1px solid rgba(0,0,0,.08);
      gap: 10px;
      flex-wrap:wrap;
    }
    .modalTop .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
    }
    .badge{
      background: rgba(240, 75, 216, .12);
      color: #7a145f;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 12px;
    }
    .modalBody{
      padding: 18px 16px 14px;
      display:grid;
      gap: 12px;
    }
    .prompt{
      font-size: clamp(18px, 2.2vw, 28px);
      font-weight: 900;
      line-height: 1.2;
    }
    .answer{
      display:none;
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(46, 204, 113, .10);
      border: 1px solid rgba(46, 204, 113, .25);
      font-size: clamp(16px, 2vw, 22px);
      font-weight: 800;
    }
    .answer.show{ display:block; }

    /* keep images from overflowing */
    .modalBody img{
      max-width: 100%;
      height: auto;
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }

    .modalActions{
      display:grid;
      gap: 10px;
      padding: 14px 16px 16px;
      border-top: 1px solid rgba(0,0,0,.08);
      background: #fafafe;
    }
    .actionRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .teamAwardRow{
      display:grid;
      gap:10px;
    }
    .awardGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 720px){
      .awardGrid{ grid-template-columns: 1fr; }
    }
    .awardBox{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:white;
    }
    .awardBox .name{ font-weight: 900; }
    .awardBox .btns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .timer{
      font-weight: 900;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.10);
      padding: 2px 6px;
      border-radius: 7px;
      font-size: 12px;
    }
    footer{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      margin-top: 12px;
    }

    details summary{
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      font-weight:700;
    }
    details[open] summary{ color: var(--ink); }

    textarea{ resize: vertical; }
  </style>
</head>

<body>
  <header>
    <h1 id="title">Jeopardy Review</h1>
    <p id="subtitle">Click a point value to open a question.</p>
  </header>

  <div class="wrap">
    <div class="layout">

      <!-- LEFT: Board -->
      <div class="card">
        <div class="cardHeader">
          <h2>Board</h2>
          <div class="controls">
            <button class="btn secondary" id="toggleModeBtn">Mode: Question ‚Üí Answer</button>

            <div class="pill" title="Optional: set a timer for each question">
              ‚è±Ô∏è Timer (sec):
              <input type="number" id="timerSeconds" min="0" step="5" value="0" />
            </div>

            <div class="pill" title="If checked, incorrect answers do NOT subtract points">
              <input type="checkbox" id="noPenaltyToggle" checked />
              <span>No penalty for incorrect</span>
            </div>

            <button class="btn secondary" id="resetUsedBtn">Reset Board</button>
            <button class="btn danger" id="hardResetBtn" title="Clears saved progress + teams">Clear Saved</button>
          </div>
        </div>

        <div class="board">
          <div class="grid" id="grid"></div>
        </div>

        <footer style="padding:0 14px 14px;">
          Keyboard: <span class="kbd">Esc</span> close ‚Ä¢ <span class="kbd">A</span> show answer ‚Ä¢ <span class="kbd">Space</span> start/pause timer
        </footer>
      </div>

      <!-- RIGHT: Setup + Scoreboard -->
      <div class="card">
        <div class="cardHeader">
          <h2>Teams & Scores</h2>
          <div class="controls">
            <button class="btn secondary" id="editTeamsBtn">Edit Teams</button>
            <button class="btn secondary" id="resetScoresBtn">Reset Scores</button>
          </div>
        </div>

        <div class="cardBody">
          <div id="setupPanel">
            <div class="setupRow">
              <div>
                <label for="teamCount">Number of teams</label>
                <input type="number" id="teamCount" min="1" max="12" value="4" />
              </div>
              <div>
                <label>Team names</label>
                <div class="teamInputs" id="teamInputs"></div>
              </div>
              <button class="btn" id="startGameBtn">Start Game</button>
              <div style="color:var(--muted); font-size:12px; line-height:1.35;">
                Tip: Use short names (e.g., ‚ÄúTeam 1‚Äù, ‚ÄúBlue‚Äù, ‚ÄúAtoms‚Äù). You can edit anytime.
              </div>
            </div>
          </div>

          <div id="scorePanel" style="display:none;">
            <div class="scoreList" id="scoreList"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Audio element (put jeopardy-theme.mp3 next to this html, or change the src path in Admin) -->
  <audio id="jeopardyAudio" preload="auto" loop>
    <source src="jeopardy-theme.mp3" type="audio/mpeg">
  </audio>

  <!-- Modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Question dialog">
    <div class="modal">
      <div class="modalTop">
        <div class="meta">
          <span class="badge" id="modalValue">$0</span>
          <span id="modalCat">Category</span>
        </div>
        <button class="btn secondary" id="closeBtn">Close</button>
      </div>

      <div class="modalBody">
        <div class="prompt" id="modalPrompt">Prompt</div>
        <div class="answer" id="modalAnswer">Answer</div>
        <div class="hint" id="modalHint"></div>
      </div>

      <div class="modalActions">
        <div class="actionRow">
          <div class="controls">
            <button class="btn" id="showAnswerBtn">Show Answer</button>
            <button class="btn secondary" id="markUsedBtn" title="Mark as used without awarding points">Mark Used</button>
          </div>

          <div class="controls">
            <div class="timer" id="timerDisplay" style="display:none;">‚è≥ 0</div>
            <button class="btn secondary" id="timerToggleBtn" style="display:none;">Start Timer</button>
          </div>
        </div>

        <div class="teamAwardRow">
          <div style="font-weight:900; color:#2b2470;">Award points</div>
          <div class="awardGrid" id="awardGrid"></div>
          <div class="hint" style="margin-top:-4px;">
            ‚ÄúCorrect‚Äù awards points and automatically marks the clue used.
            ‚ÄúIncorrect‚Äù can subtract points (unless ‚ÄúNo penalty‚Äù is checked) and keeps the clue available.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL (HIDDEN) ‚Äî Attendance-style -->
  <div class="wrap" style="margin-top:-18px; margin-bottom:26px;">
    <div class="card">
      <div class="cardBody">
        <details id="adminDetails">
          <summary>Admin (hidden)</summary>
          <div class="hint" style="margin:8px 0 10px;">
            Enter code to unlock Admin. Passcode is stored in localStorage on this computer (not shared online).
          </div>

          <div id="adminLocked">
            <div class="setupRow">
              <div>
                <label>Admin passcode</label>
                <input id="adminPasscode" type="password" placeholder="Set once / enter to unlock" />
              </div>
              <div class="controls">
                <button class="btn" id="adminUnlockBtn" type="button">Unlock Admin</button>
                <button class="btn secondary" id="adminSetBtn" type="button">Set / Change Passcode</button>
              </div>
            </div>
          </div>

          <div id="adminTools" style="display:none;">
            <div class="controls" style="justify-content:space-between; width:100%;">
              <div class="pill"><span>üîì</span><span id="adminState">Admin unlocked</span></div>
              <button class="btn secondary" id="adminLockBtn" type="button">Lock Admin</button>
            </div>

            <div style="height:1px;background:rgba(0,0,0,.08);margin:12px 0;"></div>

            <div class="setupRow">
              <div class="controls" style="gap:10px;">
                <label class="pill" style="cursor:pointer;">
                  <input type="checkbox" id="cfgAutoStartTimer" />
                  <span>Auto-start timer when clue opens</span>
                </label>

                <label class="pill" style="cursor:pointer;">
                  <input type="checkbox" id="cfgMusicOnTimer" />
                  <span>Play music during timer</span>
                </label>

                <div class="pill" title="Sets the Timer (sec) box above">
                  Default timer:
                  <input type="number" id="cfgDefaultTimer" min="0" step="5" value="0" />
                </div>

                <div class="pill" title="0.0 to 1.0">
                  üîä Volume
                  <input type="number" id="cfgMusicVol" min="0" max="1" step="0.05" value="0.35" />
                </div>

                <div class="pill" title="Example: jeopardy-theme.mp3 or audio/jeopardy-theme.mp3">
                  üéµ Music file
                  <input type="text" id="cfgMusicFile" value="jeopardy-theme.mp3" style="width:220px;" />
                </div>
              </div>

              <div class="hint">
                Tip: Put the MP3 in the same folder as this HTML, or in an <b>audio/</b> folder and set the path.
              </div>
            </div>

            <div style="height:1px;background:rgba(0,0,0,.08);margin:12px 0;"></div>
            <details id="clueBuilderDetails">
  <summary>Clue Builder (no HTML)</summary>

  <div class="hint" style="margin:8px 0 10px;">
    Enter clues in a table. Categories are created automatically. Optional: add an image filename like <b>images/q1.png</b>.
  </div>

  <div class="setupRow">
    <div class="controls" style="justify-content:space-between; align-items:center;">
      <div class="hint">One row = one clue.</div>
      <div class="controls">
        <button class="btn secondary" id="cbLoadBtn" type="button">Load from Current Game</button>
        <button class="btn" id="cbAddBtn" type="button">Add Clue</button>
        <button class="btn good" id="cbSaveBtn" type="button">Save to Game</button>
      </div>
    </div>

    <div style="overflow:auto; border:1px solid rgba(0,0,0,.10); border-radius:14px; padding:10px;">
      <table style="width:100%; border-collapse:collapse; min-width:920px;">
        <thead>
          <tr style="text-align:left; font-size:12px; color:var(--muted);">
            <th style="padding:8px 6px; width:14%;">Category</th>
            <th style="padding:8px 6px; width:8%;">Value</th>
            <th style="padding:8px 6px; width:26%;">Question</th>
            <th style="padding:8px 6px; width:26%;">Answer</th>
            <th style="padding:8px 6px; width:14%;">Hint (opt)</th>
            <th style="padding:8px 6px; width:10%;">Image (opt)</th>
            <th style="padding:8px 6px; width:2%;"></th>
          </tr>
        </thead>
        <tbody id="cbTbody"></tbody>
      </table>
    </div>

    <div class="hint" id="cbMsg" style="margin-top:8px;"></div>
  </div>
</details>

            <details>
              <summary>Game editor (JSON)</summary>
              <div class="hint" style="margin:8px 0 10px;">
                For images you can use either:
                <br>‚Ä¢ <b>a_html / q_html</b> (you already support this), OR
                <br>‚Ä¢ <b>img</b>: "images/mg.png" (auto-appended under the answer)
              </div>

              <textarea id="gameJson"
                style="width:100%;min-height:320px;box-sizing:border-box;border-radius:14px;border:1px solid rgba(0,0,0,.14);padding:12px;
                       font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;font-size:12.5px;line-height:1.35;"></textarea>

              <div class="controls" style="margin-top:10px; flex-wrap:wrap;">
                <button class="btn good" id="saveGameBtn" type="button">Save Game</button>
                <button class="btn secondary" id="exportGameBtn" type="button">Export JSON</button>
                <label class="btn secondary" style="cursor:pointer;">
                  Import JSON <input id="importGameFile" type="file" accept=".json,application/json" style="display:none;">
                </label>
                <button class="btn danger" id="resetGameBtn" type="button" title="Revert to built-in default">Reset to Default</button>
                <span class="hint" id="adminMsg" style="margin-left:auto;"></span>
              </div>
            </details>

          </div>
        </details>
      </div>
    </div>
  </div>

<script>
/* ===================== EDIT SECTION ===================== */
// IMPORTANT: GAME is now let (so Admin can override it)
let GAME = {
  id: "chem-review-01",
  title: "Jeopardy Review Game",
  subtitle: "Choose a clue. Discuss as a team.",
  jeopardyStyle: false,

  categories: [
    {
      name: "Atomic Structure",
      clues: [
        { value: 100, q: "What is the charge of an electron?", a: "Negative.", hint: "Neutral, negative, or positive?" },
        { value: 200, q: "Where are electrons found?", a: "In the energy levels/rings around the nucleus." },
        { value: 300, q: "What does the atomic number tell you?", a: "The number of protons (and electrons if neutral)." },
        { value: 400, q: "What two subatomic particles are similar is size?", a: "Protons and Neutrons" },
        { value: 500, q: "What happens to the overall charge when an atom GAINS electrons?", a: "It becomes negatively charged." }
      ]
    },
    {
      name: "Periodic Trends",
      clues: [
        { value: 100, q: "Metals are generally on which side of the periodic table?", a: "Left side (and center)." },
        { value: 200, q: "What group are the noble gases?", a: "Group 18." },
        { value: 300, q: "Alkali metals have ___ valence electron(s).", a: "1" },
        { value: 400, q: "The only elements that follow the Duet Rule are...?", a: "Hydrogen and Helium." },
        { value: 500, q: "As you move DOWN a group, the number of valence electrons __________", a: "Stays the same.", hint: "increases, decreases, stays the same" }
      ]
    },
    {
      name: "Ionic Bonding",
      clues: [
        { value: 100, q: "True or False: Ionic bonds only occur between 2 metals.", a: "False. Ionic bonds occur between a metal and a nonmetal." },
        { value: 200, q: "What is a cation?", a: "A positively charged ion (an atom that lost electrons)." },
        { value: 300, q: "Why do atoms form ions?", a: "To achieve a full valence shell (to become more stable)." },
        { value: 400, q: "True or False: If a cation and anion don't gain/lose the exact same number of electrons, they CAN'T form an ionic bond.", a: "False." },
        { value: 500, q: "When aluminum and sulfur combine to form an ionic compound, how many copies of each ion are required to create a NEUTRAL compound?", a: "2 Aluminum cations, 3 Sulfur anions." }
      ]
    },
    {
      name: "Lewis Dot Diagrams",
      clues: [
        { value: 100, q: "Draw the Lewis Dot Diagram for Magnesium. What will the charge of a Magnesium ion be?", a: "Mg ion charge is +2." },
        { value: 200, q: "Draw the Lewis Dot Diagram for Aluminum. What will the charge of an Aluminum ion be?", a: "Al ion charge is +3." },
        { value: 300, q: "Draw the Lewis Dot Diagram for an atom with 5 valence electrons. When this atom forms an ion, what will the charge be?", a: "Ion charge is -3." },
        { value: 400, q: "Consider a Lewis Dot Diagram that looks like this...  [ :C: ]. What is wrong with this diagram?", a: "Dots should be placed one on each side before pairing." },
        { value: 500, q: "Draw the Lewis Dot Diagrams for an ionic compound containing Calcium and Nitrogen. How many copies of each ion are required to create a NEUTRAL compound?",
          a: "3 Calcium cations, 2 Nitrogen anions." }
      ]
    },
    {
      name: "Misc",
      clues: [
        { value: 100, q: "How many valence electrons does Fluorine have?", a: "7" },
        { value: 200, q: "Will Be and I form an ionic bond?", a: "Yes. Be is a metal and I is a nonmetal." },
        { value: 300, q: "What will the charge of an oxygen ion be?", a: "-2" },
        { value: 400, q: "How many neutrons does Phosphorus have?", a: "16. 31 - 15 = 16." },
        { value: 500, q: "When Lithium and Nitrogen combine to form an ionic compound, how many copies of each ion are required to create a NEUTRAL compound?", a: "3 Lithium cations, 1 Nitrogen anion." }
      ]
    }
  ]
};

const DEFAULT_GAME = JSON.parse(JSON.stringify(GAME));

/* ===================== UTILITIES ===================== */
const $ = (sel) => document.querySelector(sel);

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* Render either text or html (for images/formatting). */
function setClueContent(el, htmlOrText){
  el.innerHTML = htmlOrText ?? "";
}

/* ===================== STORAGE KEYS ===================== */
const KEYS = {
  used: () => `jeopardy_used_${GAME.id}`,
  teams: () => `jeopardy_teams_${GAME.id}`,
  scores: () => `jeopardy_scores_${GAME.id}`,
};

const LS_ADMIN = {
  cfg:        () => `jeop_cfg_${GAME.id}`,
  game:       () => `jeop_game_${GAME.id}`,
  adminHash:  () => `jeop_admin_hash_${GAME.id}`,
};

/* ===================== CONFIG (ADMIN) ===================== */
const DEFAULT_CFG = {
  autoStartTimer: true,
  musicOnTimer: true,
  musicFile: "jeopardy-theme.mp3",
  musicVol: 0.35,
  defaultTimer: 0
};

function loadCfg(){
  try{
    const raw = localStorage.getItem(LS_ADMIN.cfg());
    return raw ? { ...DEFAULT_CFG, ...JSON.parse(raw) } : { ...DEFAULT_CFG };
  }catch{
    return { ...DEFAULT_CFG };
  }
}
function saveCfg(cfg){
  localStorage.setItem(LS_ADMIN.cfg(), JSON.stringify(cfg));
}

/* ===================== ADMIN: PASSCODE (SHA-256) ===================== */
let adminUnlocked = false;

async function sha256(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function setAdminPasscode(pass){
  const h = await sha256(pass);
  localStorage.setItem(LS_ADMIN.adminHash(), h);
}
async function checkAdminPasscode(pass){
  const saved = localStorage.getItem(LS_ADMIN.adminHash());
  if(!saved) return false;
  const h = await sha256(pass);
  return h === saved;
}
function showAdmin(unlocked){
  adminUnlocked = unlocked;
  $("#adminTools").style.display = unlocked ? "block" : "none";
  $("#adminLocked").style.display = unlocked ? "none" : "block";
  $("#adminState").textContent = unlocked ? "Admin unlocked" : "Admin locked";
}
async function unlockAdmin(){
  const pass = ($("#adminPasscode").value || "");
  if(await checkAdminPasscode(pass)){
    showAdmin(true);
    adminLoadUI();
  }else{
    alert("Incorrect passcode.");
  }
}
async function setPasscode(){
  const pass = ($("#adminPasscode").value || "");
  if(pass.length < 4){
    alert("Use a passcode of at least 4 characters.");
    return;
  }
  await setAdminPasscode(pass);
  alert("Passcode set on this computer.");
}
/* ===================== CLUE BUILDER ===================== */
function cbEl(id){ return document.getElementById(id); }

function cbClearMsg(){
  const m = cbEl("cbMsg");
  if(!m) return;
  m.textContent = "";
}

function cbMsg(text, ok=true){
  const m = cbEl("cbMsg");
  if(!m) return;
  m.style.color = ok ? "#146c2e" : "#8b1a1a";
  m.textContent = text;
  setTimeout(cbClearMsg, 1600);
}

function cbGetCategoryNames(){
  // current categories in GAME (unique, in order)
  const names = [];
  const seen = new Set();
  for(const c of (GAME.categories || [])){
    const n = String(c.name || "").trim();
    if(!n) continue;
    const key = n.toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    names.push(n);
  }
  return names;
}

function cbMakeCategorySelect(value=""){
  const sel = document.createElement("select");
  sel.style.width = "100%";
  sel.style.borderRadius = "10px";
  sel.style.border = "1px solid rgba(0,0,0,.14)";
  sel.style.padding = "8px 8px";
  sel.style.background = "#fff";

  const cats = cbGetCategoryNames();
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Select‚Ä¶";
  sel.appendChild(opt0);

  for(const c of cats){
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    sel.appendChild(o);
  }

  const oNew = document.createElement("option");
  oNew.value = "__new__";
  oNew.textContent = "‚ûï New category‚Ä¶";
  sel.appendChild(oNew);

  sel.value = cats.includes(value) ? value : "";

  return sel;
}

function cbMakeInput(type="text", placeholder=""){
  const inp = document.createElement(type === "textarea" ? "textarea" : "input");
  if(type !== "textarea") inp.type = type;

  inp.placeholder = placeholder;
  inp.style.width = "100%";
  inp.style.borderRadius = "10px";
  inp.style.border = "1px solid rgba(0,0,0,.14)";
  inp.style.padding = "8px 8px";
  inp.style.background = "#fff";
  inp.style.boxSizing = "border-box";
  inp.style.font = "inherit";

  if(type === "textarea"){
    inp.rows = 2;
    inp.style.resize = "vertical";
    inp.style.minHeight = "52px";
  }
  return inp;
}

function cbAddRow(rowData={}){
  const tb = cbEl("cbTbody");
  if(!tb) return;

  const tr = document.createElement("tr");
  tr.style.borderTop = "1px solid rgba(0,0,0,.08)";

  // CATEGORY cell: select + optional new-name input
  const tdCat = document.createElement("td");
  tdCat.style.padding = "6px";

  const catSel = cbMakeCategorySelect(rowData.category || "");
  const catNew = cbMakeInput("text", "New category name‚Ä¶");
  catNew.style.display = "none";

  catSel.addEventListener("change", ()=>{
    if(catSel.value === "__new__"){
      catNew.style.display = "block";
      catNew.focus();
    }else{
      catNew.style.display = "none";
      catNew.value = "";
    }
  });

  tdCat.appendChild(catSel);
  tdCat.appendChild(catNew);

  // VALUE
  const tdVal = document.createElement("td");
  tdVal.style.padding = "6px";
  const valInp = cbMakeInput("number", "100");
  valInp.min = "0";
  valInp.step = "100";
  valInp.value = String(rowData.value ?? 100);
  tdVal.appendChild(valInp);

  // QUESTION
  const tdQ = document.createElement("td");
  tdQ.style.padding = "6px";
  const qInp = cbMakeInput("textarea", "Question‚Ä¶");
  qInp.value = rowData.q ?? "";
  tdQ.appendChild(qInp);

  // ANSWER
  const tdA = document.createElement("td");
  tdA.style.padding = "6px";
  const aInp = cbMakeInput("textarea", "Answer‚Ä¶");
  aInp.value = rowData.a ?? "";
  tdA.appendChild(aInp);

  // HINT
  const tdH = document.createElement("td");
  tdH.style.padding = "6px";
  const hInp = cbMakeInput("textarea", "Hint (optional)‚Ä¶");
  hInp.rows = 2;
  hInp.value = rowData.hint ?? "";
  tdH.appendChild(hInp);

  // IMAGE
  const tdImg = document.createElement("td");
  tdImg.style.padding = "6px";
  const imgInp = cbMakeInput("text", "images/pic.png");
  imgInp.value = rowData.img ?? "";
  tdImg.appendChild(imgInp);

  // DELETE
  const tdDel = document.createElement("td");
  tdDel.style.padding = "6px";
  const delBtn = document.createElement("button");
  delBtn.type = "button";
  delBtn.className = "btn secondary";
  delBtn.textContent = "‚úï";
  delBtn.style.padding = "8px 10px";
  delBtn.addEventListener("click", ()=> tr.remove());
  tdDel.appendChild(delBtn);

  tr.appendChild(tdCat);
  tr.appendChild(tdVal);
  tr.appendChild(tdQ);
  tr.appendChild(tdA);
  tr.appendChild(tdH);
  tr.appendChild(tdImg);
  tr.appendChild(tdDel);

  tb.appendChild(tr);
}

function cbLoadFromGame(){
  const tb = cbEl("cbTbody");
  if(!tb) return;
  tb.innerHTML = "";

  // flatten GAME into rows
  const cats = GAME.categories || [];
  for(const c of cats){
    const catName = String(c.name || "").trim();
    for(const clue of (c.clues || [])){
      cbAddRow({
        category: catName,
        value: clue.value ?? 100,
        q: clue.q ?? "",
        a: clue.a ?? "",
        hint: clue.hint ?? "",
        img: clue.img ?? ""
      });
    }
  }

  if(!tb.children.length){
    // starter row
    cbAddRow({ category: "", value: 100, q: "", a: "" });
  }

  cbMsg("Loaded ‚úì", true);
}

function cbExtractRows(){
  const tb = cbEl("cbTbody");
  const rows = [...tb.querySelectorAll("tr")];

  const out = [];
  for(const tr of rows){
    const tds = tr.querySelectorAll("td");

    const sel = tds[0].querySelector("select");
    const newInp = tds[0].querySelector("input");

    let category = (sel?.value || "").trim();
    if(category === "__new__") category = (newInp?.value || "").trim();

    const value = Number(tds[1].querySelector("input")?.value || 0);
    const q = (tds[2].querySelector("textarea")?.value || "").trim();
    const a = (tds[3].querySelector("textarea")?.value || "").trim();
    const hint = (tds[4].querySelector("textarea")?.value || "").trim();
    const img = (tds[5].querySelector("input")?.value || "").trim();

    // ignore blank rows
    if(!category && !q && !a) continue;

    out.push({
      category,
      value: Number.isFinite(value) ? value : 0,
      q,
      a,
      hint: hint || undefined,
      img: img || undefined
    });
  }
  return out;
}

function cbBuildGameFromRows(rows){
  // group by category, preserve first-seen order
  const map = new Map(); // cat -> clues[]
  const order = [];

  for(const r of rows){
    const cat = (r.category || "").trim();
    if(!cat) continue;
    const key = cat.toLowerCase();
    if(!map.has(key)){
      map.set(key, { name: cat, clues: [] });
      order.push(key);
    }

    const clue = {
      value: r.value,
      q: r.q,
      a: r.a
    };
    if(r.hint) clue.hint = r.hint;
    if(r.img) clue.img = r.img;

    map.get(key).clues.push(clue);
  }

  // sort clues inside each category by value ascending
  const categories = order.map(k => {
    const c = map.get(k);
    c.clues.sort((a,b)=>(a.value??0)-(b.value??0));
    return c;
  });

  // return new GAME object, preserving title/subtitle/id and jeopardyStyle
  return {
    id: GAME.id || "jeop",
    title: GAME.title || "Jeopardy Review",
    subtitle: GAME.subtitle || "",
    jeopardyStyle: !!GAME.jeopardyStyle,
    categories
  };
}

function cbSaveToGame(){
  const rows = cbExtractRows();

  // quick validation
  if(!rows.length){
    cbMsg("Nothing to save.", false);
    return;
  }
  for(const r of rows){
    if(!r.category){
      cbMsg("Missing category on a row.", false);
      return;
    }
    if(!r.q){
      cbMsg("Missing question on a row.", false);
      return;
    }
    if(!r.a){
      cbMsg("Missing answer on a row.", false);
      return;
    }
  }

  const newGame = cbBuildGameFromRows(rows);

  // save + apply
  saveGameOverride(newGame);
  GAME = newGame;

  // refresh app
  state.modeJeopardy = !!GAME.jeopardyStyle;
  setHeader();
  buildGrid();

  // IMPORTANT: used/teams keys depend on GAME.id.
  // If user changed id in JSON earlier, this keeps things consistent.
  // Here we do NOT auto-migrate older used/teams for simplicity.

  // also refresh JSON editor view if present
  const j = document.getElementById("gameJson");
  if(j) j.value = JSON.stringify(GAME, null, 2);

  cbMsg("Saved to Game ‚úì", true);
}

function cbRefreshCategoryDropdowns(){
  // After you change the game (new categories), update existing category selects.
  const tb = cbEl("cbTbody");
  if(!tb) return;
  const rows = [...tb.querySelectorAll("tr")];

  for(const tr of rows){
    const td = tr.querySelector("td");
    if(!td) continue;
    const oldSel = td.querySelector("select");
    const oldNew = td.querySelector("input");
    if(!oldSel) continue;

    const currentValue = oldSel.value;
    const newSel = cbMakeCategorySelect(currentValue);
    newSel.addEventListener("change", ()=>{
      if(newSel.value === "__new__"){
        oldNew.style.display = "block";
        oldNew.focus();
      }else{
        oldNew.value = "";
        oldNew.style.display = "none";
      }
    });

    td.replaceChild(newSel, oldSel);
  }
}

/* Wire buttons once (call inside init after admin wiring exists) */
function cbInit(){
  const add = cbEl("cbAddBtn");
  const load = cbEl("cbLoadBtn");
  const save = cbEl("cbSaveBtn");
  if(!add || !load || !save) return;

  add.addEventListener("click", ()=> cbAddRow({ category:"", value:100, q:"", a:"" }));
  load.addEventListener("click", cbLoadFromGame);
  save.addEventListener("click", ()=>{
    cbSaveToGame();
    cbRefreshCategoryDropdowns();
  });

  // starter rows if empty
  cbLoadFromGame();

  // Optional: auto-open the Clue Builder panel so it's obvious
  const details = cbEl("clueBuilderDetails");
  if(details) details.open = true;
}

/* ===================== GAME OVERRIDE (ADMIN) ===================== */
function loadGameOverride(){
  try{
    const raw = localStorage.getItem(LS_ADMIN.game());
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && Array.isArray(parsed.categories)){
      GAME = parsed;
    }
  }catch{}
}
function saveGameOverride(obj){
  localStorage.setItem(LS_ADMIN.game(), JSON.stringify(obj));
}
function resetGameOverride(){
  localStorage.removeItem(LS_ADMIN.game());
  GAME = JSON.parse(JSON.stringify(DEFAULT_GAME));
}

/* ===================== AUDIO HELPERS ===================== */
function applyAudioCfg(){
  const cfg = loadCfg();
  const audio = $("#jeopardyAudio");
  if(!audio) return;

  const vol = Math.max(0, Math.min(1, Number(cfg.musicVol ?? 0.35)));
  audio.volume = vol;

  const srcEl = audio.querySelector("source");
  const file = String(cfg.musicFile || "jeopardy-theme.mp3").trim();
  if(srcEl && srcEl.getAttribute("src") !== file){
    srcEl.setAttribute("src", file);
    audio.load();
  }
}

function playJeopardyMusic(){
  const cfg = loadCfg();
  if(!cfg.musicOnTimer) return;

  const audio = $("#jeopardyAudio");
  if(!audio) return;
  audio.currentTime = 0;
  audio.play().catch(() => {});
}
function stopJeopardyMusic(){
  const audio = $("#jeopardyAudio");
  if(!audio) return;
  audio.pause();
  audio.currentTime = 0;
}

/* ===================== ADMIN UI WIRING ===================== */
function adminLoadUI(){
  const cfg = loadCfg();

  $("#cfgAutoStartTimer").checked = !!cfg.autoStartTimer;
  $("#cfgMusicOnTimer").checked = !!cfg.musicOnTimer;
  $("#cfgMusicFile").value = cfg.musicFile || "jeopardy-theme.mp3";
  $("#cfgMusicVol").value = cfg.musicVol ?? 0.35;
  $("#cfgDefaultTimer").value = cfg.defaultTimer ?? 0;

  // apply default timer to main timer box too
  $("#timerSeconds").value = cfg.defaultTimer ?? 0;

  applyAudioCfg();

  $("#gameJson").value = JSON.stringify(GAME, null, 2);
  $("#adminMsg").textContent = "";
}

function adminSaveCfgFromUI(){
  const cfg = loadCfg();
  cfg.autoStartTimer = $("#cfgAutoStartTimer").checked;
  cfg.musicOnTimer   = $("#cfgMusicOnTimer").checked;
  cfg.musicFile      = ($("#cfgMusicFile").value || "").trim() || "jeopardy-theme.mp3";
  cfg.musicVol       = Number($("#cfgMusicVol").value ?? 0.35);
  cfg.defaultTimer   = Number($("#cfgDefaultTimer").value ?? 0);

  // keep timer box synced
  $("#timerSeconds").value = cfg.defaultTimer;

  saveCfg(cfg);
  applyAudioCfg();
}

function adminSaveGame(){
  const msg = $("#adminMsg");
  try{
    const parsed = JSON.parse($("#gameJson").value);
    if(!parsed || !Array.isArray(parsed.categories)) throw new Error("Missing categories[]");

    saveGameOverride(parsed);
    GAME = parsed;

    // Update page
    setHeader();
    buildGrid();

    msg.style.color = "#146c2e";
    msg.textContent = "Saved ‚úì";
  }catch(e){
    msg.style.color = "#8b1a1a";
    msg.textContent = "Invalid JSON ‚úó";
  }
}

function adminExportGame(){
  const blob = new Blob([JSON.stringify(GAME, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${GAME.id || "jeopardy"}-game.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function adminImportGame(file){
  const msg = $("#adminMsg");
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const parsed = JSON.parse(reader.result);
      $("#gameJson").value = JSON.stringify(parsed, null, 2);
      msg.style.color = "#2b2470";
      msg.textContent = "Loaded. Click Save Game.";
    }catch{
      msg.style.color = "#8b1a1a";
      msg.textContent = "Could not parse file.";
    }
  };
  reader.readAsText(file);
}

function adminResetGame(){
  resetGameOverride();
  setHeader();
  buildGrid();
  $("#gameJson").value = JSON.stringify(GAME, null, 2);
  $("#adminMsg").style.color = "#2b2470";
  $("#adminMsg").textContent = "Reset ‚úì";
}

/* ===================== GAME STATE ===================== */
const state = {
  modeJeopardy: GAME.jeopardyStyle,
  used: new Set(),
  activeKey: null,
  activeValue: 0,
  teams: [],
  scores: [],
  timer: { seconds: 0, remaining: 0, running: false, interval: null }
};

/* -------- Storage (board/teams) -------- */
function loadUsed(){
  try{
    const raw = localStorage.getItem(KEYS.used());
    if(!raw) return;
    state.used = new Set(JSON.parse(raw));
  }catch(e){}
}
function saveUsed(){ localStorage.setItem(KEYS.used(), JSON.stringify([...state.used])); }

function loadTeams(){
  try{
    const rawTeams = localStorage.getItem(KEYS.teams());
    const rawScores = localStorage.getItem(KEYS.scores());
    if(rawTeams) state.teams = JSON.parse(rawTeams) || [];
    if(rawScores) state.scores = JSON.parse(rawScores) || [];
    if(state.teams.length && state.scores.length !== state.teams.length){
      state.scores = Array(state.teams.length).fill(0);
      saveTeams();
    }
  }catch(e){}
}
function saveTeams(){
  localStorage.setItem(KEYS.teams(), JSON.stringify(state.teams));
  localStorage.setItem(KEYS.scores(), JSON.stringify(state.scores));
}
function clearAllSaved(){
  localStorage.removeItem(KEYS.used());
  localStorage.removeItem(KEYS.teams());
  localStorage.removeItem(KEYS.scores());
  state.used = new Set();
  state.teams = [];
  state.scores = [];
}

/* -------- Header & Board -------- */
function setHeader(){
  $("#title").textContent = GAME.title || "Jeopardy Review";
  $("#subtitle").textContent = GAME.subtitle || "";
}

function buildGrid(){
  const grid = $("#grid");
  grid.innerHTML = "";

  const cats = GAME.categories;
  const rows = Math.max(...cats.map(c => c.clues.length));
  const cols = cats.length;

  grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;

  cats.forEach((c) => {
    const cell = document.createElement("div");
    cell.className = "cell cat";
    cell.textContent = c.name;
    grid.appendChild(cell);
  });

  for(let r=0; r<rows; r++){
    cats.forEach((c, ci) => {
      const clue = c.clues[r];
      const cell = document.createElement("div");

      if(!clue){
        cell.className = "cell";
        cell.style.opacity = "0";
        grid.appendChild(cell);
        return;
      }

      const key = `${ci}-${r}`;
      cell.className = "cell qbtn";
      cell.textContent = `$${clue.value}`;

      if(state.used.has(key)){
        cell.classList.add("used");
      }else{
        cell.addEventListener("click", () => openClue(ci, r));
      }

      grid.appendChild(cell);
    });
  }
}

/* -------- Modal / Clues -------- */
function openClue(ci, r){
  const cat = GAME.categories[ci];
  const clue = cat.clues[r];
  const key = `${ci}-${r}`;

  state.activeKey = key;
  state.activeValue = clue.value;

  $("#modalValue").textContent = `$${clue.value}`;
  $("#modalCat").textContent = cat.name;

  $("#toggleModeBtn").textContent = state.modeJeopardy
    ? "Mode: Jeopardy (Answer ‚Üí Question)"
    : "Mode: Question ‚Üí Answer";

  // choose html if provided, otherwise fall back to text
  const promptHTML = state.modeJeopardy
    ? (clue.a_html ?? escapeHtml(clue.a ?? ""))
    : (clue.q_html ?? escapeHtml(clue.q ?? ""));

  let answerHTML = state.modeJeopardy
    ? (clue.q_html ?? escapeHtml(clue.q ?? ""))
    : (clue.a_html ?? escapeHtml(clue.a ?? ""));

  // OPTIONAL TEACHER-FRIENDLY IMAGE FIELD:
  // If clue.img exists, append it under the answer.
  // (Keeps your a_html approach working too.)
  if(clue.img && !String(answerHTML).includes("<img")){
    const src = String(clue.img).trim();
    if(src){
      answerHTML += `<div style="margin-top:10px;">
        <img src="${escapeHtml(src)}" alt="Image" style="max-width:520px;width:100%;height:auto;border-radius:12px;border:1px solid rgba(0,0,0,.10);">
      </div>`;
    }
  }

  setClueContent($("#modalPrompt"), promptHTML);
  setClueContent($("#modalAnswer"), answerHTML);

  $("#modalHint").textContent = clue.hint ? `Hint: ${clue.hint}` : "";

  $("#modalAnswer").classList.remove("show");
  $("#showAnswerBtn").textContent = "Show Answer";

  setupTimerFromInput();
  resetTimer();

  renderAwardButtons();

  $("#overlay").classList.add("show");

  // Auto-start timer based on Admin config
  const cfg = loadCfg();
  if(cfg.autoStartTimer) startTimer();
}

function closeModal(){
  stopTimer();
  $("#overlay").classList.remove("show");
  state.activeKey = null;
  state.activeValue = 0;
}

function markUsedOnly(){
  if(!state.activeKey) return;
  state.used.add(state.activeKey);
  saveUsed();
  buildGrid();
  closeModal();
}

function showAnswer(){
  const el = $("#modalAnswer");
  const isShown = el.classList.toggle("show");
  $("#showAnswerBtn").textContent = isShown ? "Hide Answer" : "Show Answer";
}

function toggleMode(){
  state.modeJeopardy = !state.modeJeopardy;
  $("#toggleModeBtn").textContent = state.modeJeopardy
    ? "Mode: Jeopardy (Answer ‚Üí Question)"
    : "Mode: Question ‚Üí Answer";
  if(state.activeKey){
    const [ci, r] = state.activeKey.split("-").map(Number);
    openClue(ci, r);
  }
}

/* -------- Awarding points -------- */
function getNoPenalty(){ return $("#noPenaltyToggle").checked; }

function renderAwardButtons(){
  const wrap = $("#awardGrid");
  wrap.innerHTML = "";

  if(!state.teams.length){
    wrap.innerHTML = `<div class="hint">No teams yet. Click <b>Edit Teams</b> to set up.</div>`;
    return;
  }

  state.teams.forEach((t, i) => {
    const box = document.createElement("div");
    box.className = "awardBox";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = t.name;

    const btns = document.createElement("div");
    btns.className = "btns";

    const correct = document.createElement("button");
    correct.className = "btn good";
    correct.textContent = `Correct (+${state.activeValue})`;
    correct.addEventListener("click", () => awardCorrect(i));

    const incorrect = document.createElement("button");
    incorrect.className = "btn danger";
    incorrect.textContent = `Incorrect (${getNoPenalty() ? "0" : "-" + state.activeValue})`;
    incorrect.addEventListener("click", () => awardIncorrect(i));

    btns.appendChild(correct);
    btns.appendChild(incorrect);

    box.appendChild(name);
    box.appendChild(btns);
    wrap.appendChild(box);
  });
}

function awardCorrect(teamIndex){
  if(state.activeKey == null) return;
  state.scores[teamIndex] = (state.scores[teamIndex] || 0) + state.activeValue;

  state.used.add(state.activeKey);
  saveUsed();
  saveTeams();

  renderScoreboard();
  buildGrid();
  closeModal();
}

function awardIncorrect(teamIndex){
  if(state.activeKey == null) return;
  if(!getNoPenalty()){
    state.scores[teamIndex] = (state.scores[teamIndex] || 0) - state.activeValue;
    saveTeams();
    renderScoreboard();
  }
  renderAwardButtons();
}

/* -------- Teams UI -------- */
function buildTeamInputs(count){
  const wrap = $("#teamInputs");
  wrap.innerHTML = "";
  for(let i=0;i<count;i++){
    const inp = document.createElement("input");
    inp.type = "text";
    inp.placeholder = `Team ${i+1} name`;
    inp.value = (state.teams[i] && state.teams[i].name) ? state.teams[i].name : `Team ${i+1}`;
    wrap.appendChild(inp);
  }
}

function openTeamSetup(){
  $("#setupPanel").style.display = "block";
  $("#scorePanel").style.display = "none";

  const existing = state.teams.length ? state.teams.length : parseInt($("#teamCount").value,10) || 4;
  $("#teamCount").value = existing;
  buildTeamInputs(existing);
}

function startGameFromSetup(){
  const count = Math.max(1, Math.min(12, parseInt($("#teamCount").value, 10) || 1));
  const inputs = Array.from($("#teamInputs").querySelectorAll("input"));

  const names = inputs.slice(0,count).map((el, idx) => {
    const name = (el.value || "").trim();
    return name ? name : `Team ${idx+1}`;
  });

  state.teams = names.map(n => ({ name: n }));
  state.scores = Array(state.teams.length).fill(0);

  saveTeams();
  renderScoreboard();

  $("#setupPanel").style.display = "none";
  $("#scorePanel").style.display = "block";
}

function renderScoreboard(){
  const list = $("#scoreList");
  list.innerHTML = "";

  if(!state.teams.length){
    list.innerHTML = `<div class="hint">No teams set up yet. Click <b>Edit Teams</b> to begin.</div>`;
    return;
  }

  const order = state.teams.map((t, i) => ({
    i,
    name: t.name,
    score: state.scores[i] || 0
  })).sort((a,b) => b.score - a.score);

  order.forEach((t) => {
    const row = document.createElement("div");
    row.className = "teamCard";

    const left = document.createElement("div");
    left.innerHTML = `<div class="teamName">${escapeHtml(t.name)}</div>
                      <div style="color:var(--muted); font-size:12px;">Team ${t.i + 1}</div>`;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "10px";
    right.style.alignItems = "center";

    const score = document.createElement("div");
    score.className = "teamScore";
    score.textContent = t.score;

    const miniBtns = document.createElement("div");
    miniBtns.className = "teamMiniBtns";

    const plus50 = document.createElement("button");
    plus50.className = "btn secondary mini";
    plus50.textContent = "+50";
    plus50.title = "Quick adjust";
    plus50.addEventListener("click", () => adjustScore(t.i, 50));

    const minus50 = document.createElement("button");
    minus50.className = "btn secondary mini";
    minus50.textContent = "-50";
    minus50.title = "Quick adjust";
    minus50.addEventListener("click", () => adjustScore(t.i, -50));

    miniBtns.appendChild(plus50);
    miniBtns.appendChild(minus50);

    right.appendChild(miniBtns);
    right.appendChild(score);

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });

  if($("#overlay").classList.contains("show")){
    renderAwardButtons();
  }
}

function adjustScore(teamIndex, delta){
  state.scores[teamIndex] = (state.scores[teamIndex] || 0) + delta;
  saveTeams();
  renderScoreboard();
}

function resetScores(){
  if(!state.teams.length) return;
  state.scores = Array(state.teams.length).fill(0);
  saveTeams();
  renderScoreboard();
}

/* -------- Timer -------- */
function setupTimerFromInput(){
  const secs = parseInt($("#timerSeconds").value, 10);
  state.timer.seconds = Number.isFinite(secs) ? Math.max(0, secs) : 0;

  const show = state.timer.seconds > 0;
  $("#timerDisplay").style.display = show ? "inline-flex" : "none";
  $("#timerToggleBtn").style.display = show ? "inline-flex" : "none";
  $("#timerToggleBtn").textContent = "Start Timer";
}

function renderTimer(){ $("#timerDisplay").textContent = `‚è≥ ${state.timer.remaining}s`; }

function resetTimer(){
  stopTimer();
  state.timer.remaining = state.timer.seconds;
  renderTimer();
  $("#timerToggleBtn").textContent = "Start Timer";
}

function tick(){
  if(state.timer.remaining <= 0){
    stopTimer();
    const badge = $("#modalValue");
    badge.style.background = "rgba(255,107,107,.22)";
    setTimeout(()=> badge.style.background = "rgba(240, 75, 216, .12)", 600);
    return;
  }
  state.timer.remaining -= 1;
  renderTimer();
}

function startTimer(){
  if(state.timer.seconds <= 0) return;
  if(state.timer.running) return;

  state.timer.running = true;
  $("#timerToggleBtn").textContent = "Pause Timer";
  state.timer.interval = setInterval(tick, 1000);

  // music controlled by cfg
  playJeopardyMusic();
}

function stopTimer(){
  state.timer.running = false;
  if(state.timer.interval){
    clearInterval(state.timer.interval);
    state.timer.interval = null;
  }
  if($("#timerToggleBtn")) $("#timerToggleBtn").textContent = "Start Timer";
  stopJeopardyMusic();
}

function toggleTimer(){
  if(state.timer.seconds <= 0) return;
  if(state.timer.running) stopTimer();
  else startTimer();
}

/* -------- Reset Board -------- */
function resetBoard(){
  state.used.clear();
  saveUsed();
  buildGrid();
}

/* -------- Init -------- */
function init(){
  // Load admin overrides before building UI
  loadGameOverride();

  // If GAME changed, keep state default mode aligned
  state.modeJeopardy = !!GAME.jeopardyStyle;

  setHeader();
  applyAudioCfg();

  // Apply default timer to the box (from cfg)
  const cfg = loadCfg();
  $("#timerSeconds").value = cfg.defaultTimer ?? 0;

  loadUsed();
  loadTeams();

  const initialCount = state.teams.length ? state.teams.length : 4;
  $("#teamCount").value = initialCount;
  buildTeamInputs(initialCount);

  if(state.teams.length){
    $("#setupPanel").style.display = "none";
    $("#scorePanel").style.display = "block";
    renderScoreboard();
  }else{
    openTeamSetup();
  }

  buildGrid();

  // Board controls
  $("#toggleModeBtn").addEventListener("click", toggleMode);
  $("#resetUsedBtn").addEventListener("click", resetBoard);
  $("#hardResetBtn").addEventListener("click", () => {
    clearAllSaved();
    buildGrid();
    openTeamSetup();
    renderScoreboard();
  });

  $("#noPenaltyToggle").addEventListener("change", () => {
    if($("#overlay").classList.contains("show")) renderAwardButtons();
  });

  // Setup controls
  $("#teamCount").addEventListener("change", () => {
    const count = Math.max(1, Math.min(12, parseInt($("#teamCount").value, 10) || 1));
    buildTeamInputs(count);
  });

  $("#startGameBtn").addEventListener("click", startGameFromSetup);
  $("#editTeamsBtn").addEventListener("click", openTeamSetup);
  $("#resetScoresBtn").addEventListener("click", resetScores);

  // Modal controls
  $("#closeBtn").addEventListener("click", closeModal);
  $("#overlay").addEventListener("click", (e) => { if(e.target.id === "overlay") closeModal(); });
  $("#showAnswerBtn").addEventListener("click", showAnswer);
  $("#markUsedBtn").addEventListener("click", markUsedOnly);

  $("#timerSeconds").addEventListener("change", () => {
    setupTimerFromInput();
    if(state.activeKey) resetTimer();
  });
  $("#timerToggleBtn").addEventListener("click", toggleTimer);

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    if($("#adminDetails")?.open && e.key === "Escape"){
      // allow ESC to close admin accordion quickly
      $("#adminDetails").open = false;
      return;
    }
    if(!$("#overlay").classList.contains("show")) return;
    if(e.key === "Escape") closeModal();
    if(e.key.toLowerCase() === "a") showAnswer();
    if(e.key === " "){
      e.preventDefault();
      toggleTimer();
    }
  });

  $("#toggleModeBtn").textContent = state.modeJeopardy
    ? "Mode: Jeopardy (Answer ‚Üí Question)"
    : "Mode: Question ‚Üí Answer";

  // Admin wiring (attendance-style)
  showAdmin(false);
  $("#adminUnlockBtn").addEventListener("click", unlockAdmin);
  $("#adminSetBtn").addEventListener("click", setPasscode);
  $("#adminLockBtn").addEventListener("click", () => showAdmin(false));

  ["cfgAutoStartTimer","cfgMusicOnTimer","cfgDefaultTimer","cfgMusicVol","cfgMusicFile"].forEach(id=>{
    $("#"+id).addEventListener("change", adminSaveCfgFromUI);
  });

  $("#saveGameBtn").addEventListener("click", adminSaveGame);
  $("#exportGameBtn").addEventListener("click", adminExportGame);
  $("#resetGameBtn").addEventListener("click", adminResetGame);

  $("#importGameFile").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) adminImportGame(f);
    e.target.value = "";
  });

  // If admin is already unlocked in this session, load UI (not persisted like attendance)
  // Teacher will unlock each session when needed.
}
init();
cbInit();
</script>
</body>
</html>

