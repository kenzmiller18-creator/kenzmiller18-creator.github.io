<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Balancing Chemical Equations</title>

<style>
body {
  font-family: Georgia, serif;
  margin: 0;
  background: white;
}

/* ===== COLORS ===== */
:root {
  --H: #f6b6c9;
  --Na: #a6d98b;
  --Cl: #f4c37d;
  --toolbar: #e9c8ff;
  
  --C: #444444;
  --N: #3050f8;
  --O: #8d5656;
  --F: #90e050;
  
  --Br: #a62929;
  --I: #940094;

  
  --K: #8f40d4;
  --Li: #cc80ff;
  --Cs: #57178f;
  --Rb: #702eb0;

  --Mg: #8aff00;
  --Ca: #3dff00;
  --Al: #bfa6a6;

  --P: #ff8000;
  --S: #b1b126;
  --B: #ffb5b5;
  --Si: #f0c8a0;

  --Fe: #e06633;
}

/* ===== TOOLBAR ===== */
#toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: #efd7ff;
  border-bottom: 3px solid #000;
  box-sizing: border-box;
}

/* Left / Center / Right sections */
.toolbar-left,
.toolbar-center,
.toolbar-right {
  display: flex;
  align-items: center;
}

/* Center should actually center */
.toolbar-center {
  flex: 1;
  justify-content: center;
  text-align: center;
}

/* Prevent buttons from stacking */
.toolbar-right button {
  font-size: 14px;
  padding: 8px 16px;
  margin-left: 10px;
    border-radius: 10px;
    background-color: #4f2f92;
    color: #ffffff;
    border-color: #000000;
}

/* Hub link */
.hub-link {
  font-size: 18px;
  font-weight: bold;
  text-decoration: none;
  color: #4f2f92;
}

.hub-link:hover {
  text-decoration: underline;
}

/* Difficulty badge spacing */
#difficulty-badge {
  margin-left: 12px;
  padding: 6px 14px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}






.easy   { background: #5fbf7a; }
.medium { background: #f0a500; }
.hard   { background: #d9534f; }

#instructions {
  font-size: 14px;
}


/* ===== HUB LINK ===== */
.hub-link {
  font-size: 18px;
  font-weight: bold;
  text-decoration: none;
  color: #4f2f92;
  margin-right: 20px;
}

.hub-link:hover {
  text-decoration: underline;
}

/* ===== EQUATION ===== */
#equation {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  font-size: 36px;
  margin: 20px 40px 10px;
}

.side {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 24px;
}

.term {
  display: flex;
  align-items: center;
}

.plus {
  font-size: 36px;
}

.coeff {
  display: inline-block;
  min-width: 1.2em;
  text-align: center;
  font-size: 1.6rem;
  font-weight: bold;
  color: #2b2b2b;
  cursor: pointer;
  user-select: none;
  z-index: 5;
  position: relative;
}




/* ===== COUNTER ===== */
#counter {
  margin: 10px 40px 20px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  font-size: 26px;
}

.counter-row {
  margin: 6px 0;
}

.unbalanced {
  color: red !important;
  font-weight: bold;
}

/* ===== VISUAL ===== */
#visual {

  height: 900px;
  padding-bottom: 40px;
  margin: 0 40px 40px;
  border: 4px solid #cdb4f6;
  border-radius: 28px;
  position: relative;
  transition: border-color 0.3s;
  background: #f8eaff;
}


#visual.balanced {
  border-color: #6fdc8c;
  background: #def7e5;
}

.divider {
  position: absolute;
  left: 50%;
  top: 20px;
  bottom: 20px;
  border-left: 3px dashed #ababab;
}

.column {
  position: absolute;
  top: 60px;
  width: 260px;
  text-align: center;
}

.molecule {
  margin-bottom: 20px;
}

.atom {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin: 4px;
}

.atom.H  { background: var(--H); }
.atom.C  { background: var(--C); }
.atom.N  { background: var(--N); }
.atom.O  { background: var(--O); }
.atom.Na { background: var(--Na); }
.atom.Cl { background: var(--Cl); }
.atom.K  { background: var(--K); }
.atom.Ca { background: var(--Ca); }
.atom.Mg { background: var(--Mg); }
.atom.Al { background: var(--Al); }
.atom.S  { background: var(--S); }
.atom.P  { background: var(--P); }
.atom.F  { background: var(--F); }
.atom.Br { background: var(--Br); }
.atom.I  { background: var(--I); }
.atom.B  { background: var(--B); }
.atom.Fe  { background: var(--Fe); }
.atom.Cs  { background: var(--Cs); }
.atom.Rb  { background: var(--Rb); }
.atom.Si  { background: var(--Si); }
.atom.Li  { background: var(--Li); }

</style>
</head>

<body>

<!-- ===== TOOLBAR ===== -->
<div id="toolbar">
  <div class="toolbar-left">
    <a href="index.html" class="hub-link">← Hub</a>
  </div>

  <div class="toolbar-center">
    <div id="instructions">
      <strong>Click</strong> a coefficient to add molecules.
      <strong>Shift + Click</strong> to remove.
      
      <span id="difficulty-badge"></span>
    </div>
  </div>

  <div class="toolbar-right">
    <div id="scoreHud" style="margin-right:14px; font-weight:bold; color:#370047;">
  Score: <span id="scoreValue">0</span>
  <span id="scoreMsg" style="margin-left:10px; font-weight:normal; opacity:0.85;"></span>
</div>
    <button onclick="clearAll()">Clear</button>
    <button onclick="newEquation()">New Equation</button>


<button id="submitScoreBtn" style="background:#25202c;">Submit Score</button>

  </div>
</div>



<!-- ===== EQUATION ===== -->
<div id="equation">
  <div class="side">
    <div class="term">
      <span class="coeff" onclick="changeCoeff(event,'hcl')">_</span>
      <span><span style="color:var(--H)">H</span><span style="color:var(--Cl)">Cl</span></span>
    </div>
    <div class="plus">+</div>
    <div class="term">
      <span class="coeff" onclick="changeCoeff(event,'na')">_</span>
      <span style="color:var(--Na)">Na</span>
    </div>
  </div>

  <div style="font-size:42px;">→</div>

  <div class="side">
    <div class="term">
      <span class="coeff" onclick="changeCoeff(event,'nacl')">_</span>
      <span><span style="color:var(--Na)">Na</span><span style="color:var(--Cl)">Cl</span></span>
    </div>
    <div class="plus">+</div>
    <div class="term">
      <span class="coeff" onclick="changeCoeff(event,'h2')">_</span>
      <span><span style="color:var(--H)">H</span>₂</span>
    </div>
  </div>
</div>

<!-- ===== COUNTER ===== -->
<div id="counter">
  <div>
    <strong>Reactants</strong>
    <div id="reactants"></div>
  </div>

  <div>
    <strong>Products</strong>
    <div id="products"></div>
  </div>
</div>

<!-- ===== VISUAL ===== -->
<div id="visual">
  <div class="divider"></div>
  <div class="column" style="left:8%" id="col-hcl"></div>
  <div class="column" style="left:28%" id="col-na"></div>
  <div class="column" style="left:58%" id="col-nacl"></div>
  <div class="column" style="left:78%" id="col-h2"></div>
</div>
<div id="nameModal" style="
  display:none;
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  align-items:center; justify-content:center;
  z-index:9999;
">
  <div style="
    width:min(420px, 92vw);
    background:#fff;
    border:3px solid #000;
    border-radius:16px;
    padding:16px;
    font-family: Georgia, serif;
  ">
    <div style="font-weight:bold; font-size:18px; margin-bottom:8px;">
      Leaderboard name (optional)
    </div>
    <div style="opacity:.85; margin-bottom:10px;">
      Nickname / initials. Leave blank to stay anonymous.
    </div>
    <input id="displayNameInput" maxlength="20" placeholder="e.g., NV / BalanceBoss"
      style="width:80%; padding:10px 12px; font-size:18px; border-radius:10px; border:2px solid #999;"
    />
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
      <button id="cancelName" style="background:#eee;">Cancel</button>
      <button id="continueName" style="background:#c084fc; color:white;">Continue</button>
    </div>
  </div>
</div>


<script>
/* ===============================
   EQUATION DATA
================================ */

const equations = [

{
  difficulty: "Medium",
  reactants:[
    { key:"h3po4", formula:"H₃PO₄", comp:{H:3,P:1,O:4} },
    { key:"koh", formula:"KOH", comp:{K:1,O:1,H:1} }
  ],
  products:[
    { key:"k3po4", formula:"K₃PO₄", comp:{K:3,P:1,O:4} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ h3po4:1, koh:3, k3po4:1, h2o:3 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"k", formula:"K", comp:{K:1} },
    { key:"b2o3", formula:"B₂O₃", comp:{B:2,O:3} }
  ],
  products:[
    { key:"k2o", formula:"K₂O", comp:{K:2,O:1} },
    { key:"b", formula:"B", comp:{B:1} }
  ],
  answer:{ k:6, b2o3:1, k2o:3, b:2 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"hcl", formula:"HCl", comp:{H:1,Cl:1} },
    { key:"naoh", formula:"NaOH", comp:{Na:1,O:1,H:1} }
  ],
  products:[
    { key:"nacl", formula:"NaCl", comp:{Na:1,Cl:1} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ hcl:1, naoh:1, nacl:1, h2o:1 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"na", formula:"Na", comp:{Na:1} },
    { key:"nano3", formula:"NaNO₃", comp:{Na:1,N:1,O:3} }
  ],
  products:[
    { key:"na2o", formula:"Na₂O", comp:{Na:2,O:1} },
    { key:"n2", formula:"N₂", comp:{N:2} }
  ],
  answer:{ na:10, nano3:2, na2o:6, n2:1 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"c", formula:"C", comp:{C:1} },
    { key:"s8", formula:"S₈", comp:{S:8} }
  ],
  products:[
    { key:"cs2", formula:"CS₂", comp:{C:1,S:2} }
  ],
  answer:{ c:4, s8:1, cs2:4 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"na", formula:"Na", comp:{Na:1} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"na2o", formula:"Na₂O", comp:{Na:2,O:1} }
  ],
  answer:{ na:4, o2:1, na2o:2 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"n2", formula:"N₂", comp:{N:2} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"n2o5", formula:"N₂O₅", comp:{N:2,O:5} }
  ],
  answer:{ n2:2, o2:5, n2o5:2 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"h3po4", formula:"H₃PO₄", comp:{H:3,P:1,O:4} },
    { key:"mgoh2", formula:"Mg(OH)₂", comp:{Mg:1,O:2,H:2} }
  ],
  products:[
    { key:"mg3po42", formula:"Mg₃(PO₄)₂", comp:{Mg:3,P:2,O:8} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ h3po4:2, mgoh2:3, mg3po42:1, h2o:6 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"naoh", formula:"NaOH", comp:{Na:1,O:1,H:1} },
    { key:"h2co3", formula:"H₂CO₃", comp:{H:2,C:1,O:3} }
  ],
  products:[
    { key:"na2co3", formula:"Na₂CO₃", comp:{Na:2,C:1,O:3} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ naoh:2, h2co3:1, na2co3:1, h2o:2 }
},
{
  difficulty:"Easy",
  reactants:[
    { key:"koh", formula:"KOH", comp:{K:1,O:1,H:1} },
    { key:"hbr", formula:"HBr", comp:{H:1,Br:1} }
  ],
  products:[
    { key:"kbr", formula:"KBr", comp:{K:1,Br:1} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ koh:1, hbr:1, kbr:1, h2o:1 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"na", formula:"Na", comp:{Na:1} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"na2o", formula:"Na₂O", comp:{Na:2,O:1} }
  ],
  answer:{ na:4, o2:1, na2o:2 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"aloh3", formula:"Al(OH)₃", comp:{Al:1,O:3,H:3} },
    { key:"h2co3", formula:"H₂CO₃", comp:{H:2,C:1,O:3} }
  ],
  products:[
    { key:"al2co33", formula:"Al₂(CO₃)₃", comp:{Al:2,C:3,O:9} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ aloh3:2, h2co3:3, al2co33:1, h2o:6 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"al", formula:"Al", comp:{Al:1} },
    { key:"s8", formula:"S₈", comp:{S:8} }
  ],
  products:[
    { key:"al2s3", formula:"Al₂S₃", comp:{Al:2,S:3} }
  ],
  answer:{ al:16, s8:3, al2s3:8 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"cs", formula:"Cs", comp:{Cs:1} },
    { key:"n2", formula:"N₂", comp:{N:2} }
  ],
  products:[
    { key:"cs3n", formula:"Cs₃N", comp:{Cs:3,N:1} }
  ],
  answer:{ cs:6, n2:1, cs3n:2 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"mg", formula:"Mg", comp:{Mg:1} },
    { key:"cl2", formula:"Cl₂", comp:{Cl:2} }
  ],
  products:[
    { key:"mgcl2", formula:"MgCl₂", comp:{Mg:1,Cl:2} }
  ],
  answer:{ mg:1, cl2:1, mgcl2:1 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"rb", formula:"Rb", comp:{Rb:1} },
    { key:"rbno3", formula:"RbNO₃", comp:{Rb:1,N:1,O:3} }
  ],
  products:[
    { key:"rb2o", formula:"Rb₂O", comp:{Rb:2,O:1} },
    { key:"n2", formula:"N₂", comp:{N:2} }
  ],
  answer:{ rb:10, rbno3:2, rb2o:6, n2:1 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"c6h6", formula:"C₆H₆", comp:{C:6,H:6} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"co2", formula:"CO₂", comp:{C:1,O:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ c6h6:2, o2:15, co2:12, h2o:6 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"n2", formula:"N₂", comp:{N:2} },
    { key:"h2", formula:"H₂", comp:{H:2} }
  ],
  products:[
    { key:"nh3", formula:"NH₃", comp:{N:1,H:3} }
  ],
  answer:{ n2:1, h2:3, nh3:2 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"c10h22", formula:"C₁₀H₂₂", comp:{C:10,H:22} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"co2", formula:"CO₂", comp:{C:1,O:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ c10h22:2, o2:31, co2:20, h2o:22 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"aloh3", formula:"Al(OH)₃", comp:{Al:1,O:3,H:3} },
    { key:"hbr", formula:"HBr", comp:{H:1,Br:1} }
  ],
  products:[
    { key:"albr3", formula:"AlBr₃", comp:{Al:1,Br:3} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ aloh3:1, hbr:3, albr3:1, h2o:3 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"c4h10", formula:"C₄H₁₀", comp:{C:4,H:10} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"co2", formula:"CO₂", comp:{C:1,O:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ c4h10:2, o2:13, co2:8, h2o:10 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"c3h8", formula:"C₃H₈", comp:{C:3,H:8} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"co2", formula:"CO₂", comp:{C:1,O:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ c3h8:1, o2:5, co2:3, h2o:4 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"li", formula:"Li", comp:{Li:1} },
    { key:"alcl3", formula:"AlCl₃", comp:{Al:1,Cl:3} }
  ],
  products:[
    { key:"licl", formula:"LiCl", comp:{Li:1,Cl:1} },
    { key:"al", formula:"Al", comp:{Al:1} }
  ],
  answer:{ li:3, alcl3:1, licl:3, al:1 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"c2h6", formula:"C₂H₆", comp:{C:2,H:6} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"co2", formula:"CO₂", comp:{C:1,O:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ c2h6:2, o2:7, co2:4, h2o:6 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"nh4oh", formula:"NH₄OH", comp:{N:1,H:5,O:1} },
    { key:"h3po4", formula:"H₃PO₄", comp:{H:3,P:1,O:4} }
  ],
  products:[
    { key:"nh43po4", formula:"(NH₄)₃PO₄", comp:{N:3,H:12,P:1,O:4} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ nh4oh:3, h3po4:1, nh43po4:1, h2o:3 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"rb", formula:"Rb", comp:{Rb:1} },
    { key:"p", formula:"P", comp:{P:1} }
  ],
  products:[
    { key:"rb3p", formula:"Rb₃P", comp:{Rb:3,P:1} }
  ],
  answer:{ rb:3, p:1, rb3p:1 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"ch4", formula:"CH₄", comp:{C:1,H:4} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"co2", formula:"CO₂", comp:{C:1,O:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ ch4:1, o2:2, co2:1, h2o:2 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"aloh3", formula:"Al(OH)₃", comp:{Al:1,O:3,H:3} },
    { key:"h2so4", formula:"H₂SO₄", comp:{H:2,S:1,O:4} }
  ],
  products:[
    { key:"al2so43", formula:"Al₂(SO₄)₃", comp:{Al:2,S:3,O:12} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ aloh3:2, h2so4:3, al2so43:1, h2o:6 }
},

{
  difficulty:"Easy",
  reactants:[
    { key:"na", formula:"Na", comp:{Na:1} },
    { key:"cl2", formula:"Cl₂", comp:{Cl:2} }
  ],
  products:[
    { key:"nacl", formula:"NaCl", comp:{Na:1,Cl:1} }
  ],
  answer:{ na:2, cl2:1, nacl:2 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"rb", formula:"Rb", comp:{Rb:1} },
    { key:"s8", formula:"S₈", comp:{S:8} }
  ],
  products:[
    { key:"rb2s", formula:"Rb₂S", comp:{Rb:2,S:1} }
  ],
  answer:{ rb:16, s8:1, rb2s:8 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"h3po4", formula:"H₃PO₄", comp:{H:3,P:1,O:4} },
    { key:"caoh2", formula:"Ca(OH)₂", comp:{Ca:1,O:2,H:2} }
  ],
  products:[
    { key:"ca3po42", formula:"Ca₃(PO₄)₂", comp:{Ca:3,P:2,O:8} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ h3po4:2, caoh2:3, ca3po42:1, h2o:6 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"nh3", formula:"NH₃", comp:{N:1,H:3} },
    { key:"hcl", formula:"HCl", comp:{H:1,Cl:1} }
  ],
  products:[
    { key:"nh4cl", formula:"NH₄Cl", comp:{N:1,H:4,Cl:1} }
  ],
  answer:{ nh3:1, hcl:1, nh4cl:1 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"li", formula:"Li", comp:{Li:1} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  products:[
    { key:"lioh", formula:"LiOH", comp:{Li:1,O:1,H:1} },
    { key:"h2", formula:"H₂", comp:{H:2} }
  ],
  answer:{ li:2, h2o:2, lioh:2, h2:1 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"ca3po42", formula:"Ca₃(PO₄)₂", comp:{Ca:3,P:2,O:8} },
    { key:"sio2", formula:"SiO₂", comp:{Si:1,O:2} },
    { key:"c", formula:"C", comp:{C:1} }
  ],
  products:[
    { key:"casio3", formula:"CaSiO₃", comp:{Ca:1,Si:1,O:3} },
    { key:"co", formula:"CO", comp:{C:1,O:1} },
    { key:"p", formula:"P", comp:{P:1} }
  ],
  answer:{ ca3po42:1, sio2:3, c:5, casio3:3, co:5, p:2 }
},

{
  difficulty:"Medium",
  reactants:[
    { key:"nh3", formula:"NH₃", comp:{N:1,H:3} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"n2", formula:"N₂", comp:{N:2} },
    { key:"h2o", formula:"H₂O", comp:{H:2,O:1} }
  ],
  answer:{ nh3:4, o2:3, n2:2, h2o:6 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"fes2", formula:"FeS₂", comp:{Fe:1,S:2} },
    { key:"o2", formula:"O₂", comp:{O:2} }
  ],
  products:[
    { key:"fe2o3", formula:"Fe₂O₃", comp:{Fe:2,O:3} },
    { key:"so2", formula:"SO₂", comp:{S:1,O:2} }
  ],
  answer:{ fes2:4, o2:11, fe2o3:2, so2:8 }
},

{
  difficulty:"Hard",
  reactants:[
    { key:"c", formula:"C", comp:{C:1} },
    { key:"so2", formula:"SO₂", comp:{S:1,O:2} }
  ],
  products:[
    { key:"cs2", formula:"CS₂", comp:{C:1,S:2} },
    { key:"co", formula:"CO", comp:{C:1,O:1} }
  ],
  answer:{ c:5, so2:2, cs2:1, co:4 }
}

];



/* ===============================
   STATE
================================ */

let currentEq = null;
let coeffs = {};
// ===== SCORE ENGINE (Balancing Equations) =====
const score = {
  value: 0,
  startedAt: Date.now(),
  attempts: 0,          // coefficient clicks
  solves: 0,            // solved equations this session
  currentStart: Date.now(),
  currentSolved: false,
  lastSolve: null,      // store last solve details
  events: [],
};

const SCORE_RULES = {
  baseByDifficulty: { Easy: 50, Medium: 80, Hard: 120 },
  timeCapSeconds: 120,     // max time bonus window
  timeBonusMax: 120,       // up to +120 if under cap
  clickBonusMax: 60,       // up to +60 if under click cap
  clickCap: 60,            // >=60 clicks => 0 bonus
  minScore: 0,
};

function flashMsg(text) {
  const el = document.getElementById("scoreMsg");
  if (!el) return;
  el.textContent = text;
  clearTimeout(flashMsg._t);
  flashMsg._t = setTimeout(() => (el.textContent = ""), 1400);
}

function renderScore() {
  const el = document.getElementById("scoreValue");
  if (el) el.textContent = score.value;
}

function clampScore() {
  if (score.value < SCORE_RULES.minScore) score.value = SCORE_RULES.minScore;
}

function addScore(type, delta, meta = {}) {
  score.value += delta;
  clampScore();
  score.events.push({ t: Date.now(), type, delta, scoreAfter: score.value, ...meta });
  renderScore();
  if (delta !== 0) flashMsg((delta > 0 ? "+" : "") + delta);
}

function startEquationTimer() {
  score.currentStart = Date.now();
  score.currentSolved = false;
  score.attempts = 0;
}

function equationSeconds() {
  return Math.floor((Date.now() - score.currentStart) / 1000);
}

function recordAttempt() {
  score.attempts++;
}

// call when equation is solved (first time only)
function onSolveBalanced() {
  if (score.currentSolved) return;
  score.currentSolved = true;
  score.solves++;

  const diff = (currentEq && currentEq.difficulty) ? currentEq.difficulty : "Medium";
  const base = SCORE_RULES.baseByDifficulty[diff] ?? 80;

  const sec = equationSeconds();
  const timeBonus = Math.max(0, SCORE_RULES.timeBonusMax - Math.min(SCORE_RULES.timeBonusMax, sec));
  const clickBonus = Math.max(0, SCORE_RULES.clickBonusMax - Math.min(SCORE_RULES.clickBonusMax, score.attempts));

  const gained = base + timeBonus + clickBonus;

  score.lastSolve = {
    difficulty: diff,
    seconds: sec,
    attempts: score.attempts,
    gained,
  };

  addScore("solve", gained, score.lastSolve);
  flashMsg(`Solved! +${gained} (${diff}, ${sec}s, ${score.attempts} clicks)`);
}

function scoreSummary() {
  const totalSeconds = Math.floor((Date.now() - score.startedAt) / 1000);
  return {
    score: score.value,
    solves: score.solves,
    attempts: score.attempts,
    seconds: totalSeconds,
    lastSolve: score.lastSolve,
    events: score.events,
  };
}

renderScore();

/* ===============================
   LOAD NEW EQUATION
================================ */
function updateDifficulty(){
  const badge = document.getElementById("difficulty-badge");
  const level = currentEq.difficulty || "Medium";

  badge.innerText = level;
  badge.className = "";
  badge.classList.add(level.toLowerCase());
}
function newEquation() {
  currentEq = equations[Math.floor(Math.random() * equations.length)];
  coeffs = {};

  [...currentEq.reactants, ...currentEq.products]
    .forEach(s => coeffs[s.key] = 0);

  renderEquation();
  renderVisualColumns();
  updateDifficulty(); 
  startEquationTimer();
  update();
}


/* ===============================
   RENDER EQUATION
================================ */

function renderEquation() {
  const eq = document.getElementById("equation");
  eq.innerHTML = "";

  eq.appendChild(renderSide(currentEq.reactants));
  eq.appendChild(Object.assign(document.createElement("div"), {
    innerText:"→",
    style:"font-size:42px;"
  }));
  eq.appendChild(renderSide(currentEq.products));
}

function renderSide(list) {
  const side = document.createElement("div");
  side.className = "side";

  list.forEach((s,i) => {
    const term = document.createElement("div");
    term.className = "term";

    const coeff = document.createElement("span");
    coeff.className = "coeff";
    coeff.dataset.key = s.key;
    coeff.innerText = "_";
    coeff.onclick = e => changeCoeff(e, s.key);


    const label = document.createElement("span");
    label.innerHTML = colorizeFormula(
    s.formula || keyToFormula(s.key)
    );



    term.append(coeff,label);
    side.appendChild(term);

    if(i < list.length-1){
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText="+";
      side.appendChild(plus);
    }
  });

  return side;
}
function keyToFormula(key){
  return key
    .replace(/\d+/g, n => "₀₁₂₃₄₅₆₇₈₉"[n])
    .replace(/([a-z])([A-Z])/g,"$1$2");
}

/* ===============================
   COLORIZE FORMULA
================================ */

function colorizeFormula(formula){
  return formula.replace(/([A-Z][a-z]?)/g,
    el => `<span style="color:var(--${el})">${el}</span>`);
}

/* ===============================
   COEFFICIENT CONTROL
================================ */

function changeCoeff(e, key){
  recordAttempt(); 

  if (e.shiftKey) {
    coeffs[key] = Math.max(0, coeffs[key] - 1);
  } else {
    coeffs[key] = coeffs[key] + 1;
  }

  // ✅ Update ALL coefficient displays correctly
  document.querySelectorAll(".coeff").forEach(c => {
    const k = c.dataset.key;
    c.innerText = coeffs[k] === 0 ? "_" : coeffs[k];
  });

  update();
}



/* ===============================
   VISUALIZATION
================================ */

function renderVisualColumns(){
  const v=document.getElementById("visual");
  v.innerHTML='<div class="divider"></div>';

  const all=[...currentEq.reactants,...currentEq.products];
  const gap=80/(all.length+1);

  all.forEach((s,i)=>{
    const col=document.createElement("div");
    col.className="column";
    col.id="col-"+s.key;
    col.style.left=(i<currentEq.reactants.length
      ? 5+gap*i
      : 55+gap*(i-currentEq.reactants.length)
    )+"%";
    v.appendChild(col);
  });
}
function draw() {
  [...currentEq.reactants, ...currentEq.products].forEach(s => {
    const col = document.getElementById("col-" + s.key);
    col.innerHTML = "";

    for (let i = 0; i < coeffs[s.key]; i++) {
      const m = document.createElement("div");
      m.className = "molecule";
      m.style.position = "absolute";

      const atomSize = 42;
      let atoms = [];
      let positions = [];

      switch (s.key.toLowerCase()) {

        // ================= H2O =================
        case "h2o":
          atoms = ["H", "H", "O"];
          positions = [
            { x: 0, y: 0 },                   // H left
            { x: atomSize, y: 0 },            // H right
            { x: atomSize/2, y: atomSize*0.866 } // O bottom
          ];
          break;

// ================= NH3 =================
case "nh3": {
  atoms = ["N", "H", "H", "H"];
  const center = atomSize; // central N
  const radius = atomSize; // distance from N to H

  // N in center
  positions = [
    { x: center, y: center }, // N center
    { x: center, y: center - radius },                        // H top
    { x: center - radius * Math.sin(Math.PI / 3), y: center + radius * 0.5 }, // H bottom-left
    { x: center + radius * Math.sin(Math.PI / 3), y: center + radius * 0.5 }  // H bottom-right
  ];
  break;
}

// ================= CH4 =================
case "ch4": {
  atoms = ["C", "H", "H", "H", "H"];
  const center = atomSize; // central C
  const radius = atomSize; // distance from C to H

  // C in center
  positions = [
    { x: center, y: center }, // C center
    { x: center, y: center - radius },                      // H top
    { x: center - radius, y: center },                      // H left
    { x: center + radius, y: center },                      // H right
    { x: center, y: center + radius }                       // H bottom
  ];
  break;
}


        // ================= CO2 =================
        case "co2":
          atoms = ["O", "C", "O"];
          positions = [
            { x: 0, y: atomSize },       // O left
            { x: atomSize, y: atomSize },// C center
            { x: atomSize*2, y: atomSize } // O right
          ];
          break;

        // ================= Default =================
        default:
          atoms = [];
          for (let el in s.comp) {
            for (let j = 0; j < s.comp[el]; j++) atoms.push(el);
          }
          const atomsPerRow = Math.ceil(Math.sqrt(atoms.length));
          const spacing = atomSize;
          positions = atoms.map((_, index) => ({
            x: (index % atomsPerRow) * spacing,
            y: Math.floor(index / atomsPerRow) * spacing
          }));
          break;
      }

      // ===== Compute molecule bounding box =====
      let minX = Math.min(...positions.map(p => p.x));
      let maxX = Math.max(...positions.map(p => p.x));
      let minY = Math.min(...positions.map(p => p.y));
      let maxY = Math.max(...positions.map(p => p.y));

      const moleculeWidth = maxX - minX + atomSize;
      const moleculeHeight = maxY - minY + atomSize;

      // ===== Shift atoms so top-left = (0,0) =====
      positions = positions.map(p => ({ x: p.x - minX, y: p.y - minY }));

      // ===== Create atom divs =====
      atoms.forEach((el, index) => {
        const a = document.createElement("div");
        a.className = "atom " + el;
        a.innerText = el;
        a.style.position = "absolute";
        const pos = positions[index];
        a.style.left = pos.x + "px";
        a.style.top = pos.y + "px";
        m.appendChild(a);
      });

      // ===== Stack molecules vertically without overlap =====
      m.style.top = i * (moleculeHeight + 8) + "px"; // 8px padding
      m.style.left = 0;

      col.appendChild(m);
    }
  });
}










/* ===============================
   ATOM COUNTING
================================ */

function update(){
  draw();
  const balanced = countAtoms();
  document.getElementById("visual")
    .classList.toggle("balanced", balanced);

    if (balanced) onSolveBalanced();
}

function countAtoms(){
  const r={},p={};

  currentEq.reactants.forEach(s=>{
    for(let e in s.comp){
      r[e]=(r[e]||0)+coeffs[s.key]*s.comp[e];
    }
  });

  currentEq.products.forEach(s=>{
    for(let e in s.comp){
      p[e]=(p[e]||0)+coeffs[s.key]*s.comp[e];
    }
  });

  renderCounter("reactants",r,p);
  renderCounter("products",p,r);

  const exists=Object.values(coeffs).some(v=>v>0);
  return exists && Object.keys(r).every(e=>r[e]===p[e]);
}

function renderCounter(id,a,b){
  const d=document.getElementById(id);
  d.innerHTML="";
  Object.keys({...a,...b}).forEach(e=>{
    const row=document.createElement("div");
    row.className="counter-row";
    row.style.color=`var(--${e})`;
    if((a[e]||0)!==(b[e]||0)) row.classList.add("unbalanced");
    row.innerText=`${e}: ${a[e]||0}`;
    d.appendChild(row);
  });
}
// ===== GOOGLE FORM AUTOSUBMIT (formResponse) =====
// Uses the SAME form + entries as your Ionic sim

const SIM_ID = "balancing_equations";
const TOKEN_SALT = "MoLeCuTeOrG";

// IMPORTANT: This is the autosubmit endpoint
const FORM_BASE_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSckXbWQsVWobjrktGMoF7AtY6gMch0eQMjsGlddVv1cxgNHgQ/formResponse";

// If you already have nickname entry id, fill it in here.
// If not, leave it commented — form will still submit without nickname.
const FORM_ENTRIES = {
  displayName: "entry.366340186",
  sim: "entry.1832756779",
  score: "entry.221944829",
  token: "entry.1636605257",
};

function fnv1a(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = (h * 0x01000193) >>> 0;
  }
  return ("00000000" + h.toString(16)).slice(-8);
}

function makeToken(summary) {
  const payload = {
    v: 1,
    sim: SIM_ID,
    score: summary.score,
    solves: summary.solves ?? 0,
    attempts: summary.attempts ?? 0,
    seconds: summary.seconds ?? 0,
    last: summary.lastSolve ?? null,
    t: Date.now(),
    nonce: Math.random().toString(36).slice(2, 10),
  };
  const core = JSON.stringify(payload);
  payload.sig = fnv1a(core + "|" + TOKEN_SALT);
  return btoa(JSON.stringify(payload));
}

function askDisplayName() {
  return new Promise((resolve) => {
    const modal = document.getElementById("nameModal");
    const input = document.getElementById("displayNameInput");
    const cancel = document.getElementById("cancelName");
    const cont = document.getElementById("continueName");

    function close(val) {
      modal.style.display = "none";
      cancel.onclick = null;
      cont.onclick = null;
      modal.onclick = null;
      document.onkeydown = null;
      resolve(val);
    }

    input.value = "";
    modal.style.display = "flex";
    input.focus();

    cancel.onclick = () => close(null);
    cont.onclick = () => close(input.value.trim());

    modal.onclick = (e) => { if (e.target === modal) close(null); };
    document.onkeydown = (e) => {
      if (e.key === "Escape") close(null);
      if (e.key === "Enter") close(input.value.trim());
    };
  });
}

function buildFormBody({ displayName = "", sim, score, token }) {
  const params = new URLSearchParams();
  if (displayName && FORM_ENTRIES.displayName) params.set(FORM_ENTRIES.displayName, displayName);
  params.set(FORM_ENTRIES.sim, sim);
  params.set(FORM_ENTRIES.score, String(score));
  params.set(FORM_ENTRIES.token, token);
  return params;
}

function resetScoreSession() {
  score.value = 0;
  score.startedAt = Date.now();
  score.events = [];
  score.solves = 0;
  score.attempts = 0;
  score.currentSolved = false;
  score.lastSolve = null;
  startEquationTimer();
  renderScore();
  flashMsg("Submitted + reset");
}

const submitBtn = document.getElementById("submitScoreBtn");
if (submitBtn) {
  submitBtn.onclick = async () => {
    const summary = scoreSummary();
    const token = makeToken(summary);

    const displayName = await askDisplayName();
    if (displayName === null) return;

    const body = buildFormBody({
      displayName,
      sim: SIM_ID,
      score: summary.score,
      token,
    });

    // silent autosubmit
    fetch(FORM_BASE_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString(),
    });

    resetScoreSession();
  };
}

/* ===============================
   CLEAR
================================ */

function clearAll(){
  Object.keys(coeffs).forEach(k=>coeffs[k]=0);
  document.querySelectorAll(".coeff").forEach(c=>c.innerText="_");
  update();
}

/* ===============================
   INIT
================================ */

newEquation();
</script>


</body>
</html>
